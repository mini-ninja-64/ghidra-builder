# vim: expandtab tabstop=2 shiftwidth=2
name: CI

on:
  workflow_dispatch:
    inputs:
      unk:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  GRADLE_VERSION: 9.1.0
  JAVA_VERSION: '21'

jobs:
  build:
    name: 'Build Ghidra - ${{ matrix.platform.os }} - ${{ matrix.ghidra.version }}'
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os: 'windows-latest'
            dependency_script: |
              choco install visualstudio2017buildtools
              choco install winflexbison
              choco install python
              ren "C:\ProgramData\chocolatey\bin\win_bison.exe" "bison.exe"
              ren "C:\ProgramData\chocolatey\bin\win_flex.exe" "flex.exe"
              
        ghidra:
          - version: 'dev'
            ref: 'master'
          - version: 'stable'
            ref: 'stable'
    runs-on: "${{ matrix.platform.os }}"
    steps:
      - uses: actions/checkout@v2
      - name: 'Set up JDK'
        uses: actions/setup-java@v1
        with:
          java-version: ${{ env.JAVA_VERSION }}
          java-package: 'jdk'
      - name: "Install dependencies"
        run: "${{ matrix.platform.dependency_script }}"
      
      - name: "Clone Ghidra"
        run: git clone -b "${{ matrix.ghidra.ref }}" "https://github.com/NationalSecurityAgency/ghidra.git" ghidra

      - name: "Recent history"
        run: git log --oneline -n 15
        working-directory: ./ghidra

      - name: "Fetch dependencies"
        run: ./gradlew.bat --init-script gradle/support/fetchDependencies.gradle 
        working-directory: ./ghidra

      - name: "Fetch dependencies"
        run: ./gradlew.bat prepdev
        working-directory: ./ghidra

      - name: "Building natives"
        run: ./gradlew.bat buildNatives
        working-directory: ./ghidra

      - name: "Compiling sleigh files"
        run: ./gradlew.bat sleighCompile
        working-directory: ./ghidra

      - name: "Building Python3 packages"
        run: ./gradlew.bat buildPyPackage
        working-directory: ./ghidra

      - name: "Assemble ghidra"
        run: ./gradlew.bat assembleAll
        working-directory: ./ghidra
      
      - name: "Building Ghidra ${{ matrix.ghidra.version }} from ${{ matrix.ghidra.ref }}"
        run: ./gradlew.bat buildGhidra
        working-directory: ./ghidra

      - name: "Upload package"
        uses: NyaMisty/upload-artifact@nightly
        with:
          name: "Ghidra_${{ matrix.ghidra.version }}_${{ matrix.platform.os }}"
          path: "ghidra/build/dist/*.zip"

  deploy:
    name: 'Push to Release'
    if: always()
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: mkdir dist
      - name: Download built artifacts
        uses: actions/download-artifact@master
        with:
          path: dist
      - name: Rearrange artifacts
        run: |
          mkdir dist1
          find dist -type f -name "*" -exec sh -c 'mv "{}" "dist1/$( basename "$( dirname "{}" )" )_$( basename "{}" )"' \;
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
      - name: Pushing to release
        uses: ncipollo/release-action@v1
        with:
          name: "GhidraNightlyBuild-${{ steps.date.outputs.date }}"
          commit: ${{ github.sha }}
          tag: "GhidraNightlyBuild-${{ steps.date.outputs.date }}"
          artifacts: "dist1/*.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: NyaMisty/keepalive-workflow@v2 # using the workflow with default settings
